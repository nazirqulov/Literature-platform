<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kirish - Literature Platform</title>
    <link rel="stylesheet" href="css/style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;600;700&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="auth-page">
        <div class="auth-bg"></div>
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <h1>Xush kelibsiz</h1>
                    <p>Hisobingizga kiring</p>
                </div>

                <form id="loginForm" class="auth-form">
                    <div class="form-group">
                        <label for="usernameOrEmail">Username yoki Email</label>
                        <input type="text" id="usernameOrEmail" name="usernameOrEmail"
                            placeholder="username yoki email@example.com" required>
                    </div>

                    <div class="form-group">
                        <label for="password">Parol</label>
                        <div class="password-input">
                            <input type="password" id="password" name="password" placeholder="••••••••" required>
                            <button type="button" class="toggle-password" onclick="togglePassword('password')">
                                <svg class="eye-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
                                    <path
                                        d="M15 12C15 13.6569 13.6569 15 12 15C10.3431 15 9 13.6569 9 12C9 10.3431 10.3431 9 12 9C13.6569 9 15 10.3431 15 12Z"
                                        stroke="currentColor" stroke-width="2" />
                                    <path
                                        d="M12 5C7 5 2.73 8.11 1 12.5C2.73 16.89 7 20 12 20C17 20 21.27 16.89 23 12.5C21.27 8.11 17 5 12 5Z"
                                        stroke="currentColor" stroke-width="2" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="form-footer">
                        <label class="checkbox">
                            <input type="checkbox" name="remember">
                            <span>Eslab qolish</span>
                        </label>
                        <a href="forgot-password.html" class="link">Parolni unutdingizmi?</a>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block" id="loginButton">
                        <span>Kirish</span>
                        <div class="spinner" style="display: none;"></div>
                    </button>

                    <div class="auth-divider">
                        <span>yoki</span>
                    </div>

                    <div class="auth-switch">
                        <p>Hisobingiz yo'qmi? <a href="register.html" class="link">Ro'yxatdan o'tish</a></p>
                    </div>
                </form>

                <div class="alert alert-error" id="errorAlert" style="display: none;"></div>
            </div>

            <a href="index.html" class="back-home">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" />
                </svg>
                Bosh sahifaga qaytish
            </a>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const button = document.getElementById('loginButton');
            const spinner = button.querySelector('.spinner');
            const buttonText = button.querySelector('span');
            const errorAlert = document.getElementById('errorAlert');

            // Hide previous errors
            errorAlert.style.display = 'none';

            // Show loading
            button.disabled = true;
            spinner.style.display = 'inline-block';
            buttonText.textContent = 'Kirish...';

            try {
                const usernameOrEmail = document.getElementById('usernameOrEmail').value;
                const password = document.getElementById('password').value;

                console.log('Login urinishi:', { usernameOrEmail });

                const response = await api.post('/auth/login', {
                    usernameOrEmail,
                    password
                });

                console.log('Login response:', response);

                // Save token and user data
                localStorage.setItem('token', response.data.token);
                localStorage.setItem('user', JSON.stringify(response.data.user));

                // Show success message
                showToast('Muvaffaqiyatli kirdingiz!', 'success');

                // Redirect to home
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);

            } catch (error) {
                console.error('Login xatolik:', error);

                let errorMessage = 'Login xatolik yuz berdi. Qaytadan urinib ko\'ring.';

                // Check if it's a network error (backend not running)
                if (!error.response) {
                    errorMessage = '⚠️ Server bilan aloqa yo\'q! Backend server ishlamayapti. Port 8080 da serverni ishga tushiring.';
                } else if (error.response.status === 401) {
                    errorMessage = 'Username yoki parol noto\'g\'ri!';
                } else if (error.response.status === 403) {
                    errorMessage = 'Kirish taqiqlangan!';
                } else if (error.response?.data?.message) {
                    errorMessage = error.response.data.message;
                }

                errorAlert.textContent = errorMessage;
                errorAlert.style.display = 'block';

                // Reset button
                button.disabled = false;
                spinner.style.display = 'none';
                buttonText.textContent = 'Kirish';
            }
        });

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>

</html>